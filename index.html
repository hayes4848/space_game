<html>
<head>
	<title>Smartphone Controller Game</title>
	<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
	<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
	<script type="text/javascript" src="/socket.io/socket.io.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r73/three.js"></script>
	<script src="https://s3.amazonaws.com/gamepad-js/MTLLoader.js"></script>
	<script src="https://s3.amazonaws.com/gamepad-js/OBJLoader.js"></script> 
	<script src="https://s3.amazonaws.com/gamepad-js/tween.js"></script>
	<script src="https://s3.amazonaws.com/gamepad-js/qrcode.min.js"></script>
	<style>
		body{
			margin: 0;
		}
		#QR_code{
			position: absolute;
			top: 40%;
			left: 40%;
			padding: 20px;
			background: white;
		}
		.buttons{
			display: none;
			background-color: gray;
			height: 100%;
		}
		.buttons img{
			position: absolute;
			width: 25%;
		}
		#toparrow{
			-webkit-transform: rotate(90deg);
			top: 0;
			margin-left: 37%;
			margin-right: 37%;
		}
		#bottomarrow{
			-webkit-transform: rotate(90deg);
			bottom: 0;
			margin-left: 37%;
			margin-right: 37%;
		}
		#arrow{
			right: 0;
			margin-top: 50%;
			/*margin-left: 50%;*/


		}
		#backarrow{
			left: 0;
			margin-top: 50%;
		}
	</style>
</head>
<body>
	<div class="buttons">
		<img id="toparrow" src="BackArrow.svg">
		<img id="backarrow" src="BackArrow.svg">
		<img id="arrow" src="Arrow.svg">
		<img id="bottomarrow" src="Arrow.svg">
	</div>
</body>
<script>
var ip = '10.225.49.144', // Your ip
		port = ':3000',
		io = io.connect(),
		current_url = window.location.href;
io.on('connect', function() {
	// Game setup
	var game = function(ip){
		var QR_code_element,
		create_QR = function(){
			var QR_code,
					// url = "http://" + ip + port + "?id=" + io.id;
					   url = "http://hichew-phone-game.herokuapp.com/?id=" + io.id;
			// Create the container for the QR code to be created in
			QR_code_element = document.createElement('div');
			// Assign an id to the element
			QR_code_element.id = "QR_code";
			// Append QR code element to the body
			document.body.appendChild(QR_code_element);
			// Assign the actual DOM element
			QR_code_element = document.getElementById('QR_code');
			// Create a QRCode
			QR_code = new QRCode("QR_code");
			QR_code.makeCode(url);
		},
		game_connected = function(){
			create_QR();
			io.removeListener('game_connected', game_connected);
		}
	 var scene = new THREE.Scene();
	 var rotationX = 0;
	 var rotationY = 0;
	 var starship, ship, rock, collisionBox;
	 var spaceship = null;
	 var tunnels = [];
	 var NUMOFASTEROIDS = 12;
	 var asteroids = [];
	 var hitBox = new THREE.Box3();
	 var shots = [];
	 var manager = new THREE.LoadingManager();
					manager.onProgress = function ( item, loaded, total ) {

					};

	  // This is what sees the stuff:
	  var aspect_ratio = window.innerWidth / window.innerHeight;
	  var camera = new THREE.PerspectiveCamera(75, aspect_ratio, 1, 10000);
	  camera.position.z = 200;
	  camera.position.y = 100;
	  camera.lookAt(0,0,0);
	  camera.setLens(35);
	  scene.add(camera);

	  // This will draw what the camera sees onto the screen:
	  var renderer = new THREE.WebGLRenderer({antialias: true, alpha:true});
	  renderer.setSize(window.innerWidth, window.innerHeight);
	  renderer.setClearColor(0x000022, 1);
	  document.body.appendChild(renderer.domElement);

	  var ambLight = new THREE.AmbientLight(0xFFFFFF, 0.9);
	  scene.add(ambLight);
	  scene.fog = new THREE.FogExp2(0x0000022, 0.00125)

	  // ******** START CODING ON THE NEXT LINE ********

	
	var materialGreenApple = new THREE.MeshPhongMaterial({
	    map: THREE.ImageUtils.loadTexture('green_apple_with_gray.png'),
	    specular: 0xBDBEC7,
	    shininess: 50,
	  });


	var material = new THREE.MeshBasicMaterial({map: THREE.ImageUtils.loadTexture('space-background.jpg', 
	  null, function(tex) {
      tex.wrapS = tex.wrapT = THREE.RepeatWrapping
      tex.repeat.set(1, 5)
      tex.needsUpdate = true
    }),
    
	side: THREE.BackSide});

var tube = new THREE.CylinderGeometry(300, 300, 5000, 24, 24, true);
var tunnel1 = new THREE.Mesh(tube, material);	
tunnel1.rotation.x = -Math.PI/2;
scene.add(tunnel1);
tunnels.push(tunnel1);

var tube = new THREE.CylinderGeometry(300, 300, 5000, 24, 24, true);
var tunnel2 = new THREE.Mesh(tube, material);	
tunnel2.rotation.x = -Math.PI/2;
tunnel2.position.set(0,0,-5000);
scene.add(tunnel2);
tunnels.push(tunnel2);


//spaceship 
var spaceShip = function(){
	var loader = new THREE.OBJLoader( manager ), self = this;
		spaceship = new THREE.Object3D();
		this.loaded = false;
		loader.load( 'ARC170.obj', function ( object ) {
			object.traverse( function ( child ) {
				if ( child instanceof THREE.Mesh ) {
					child.material = materialGreenApple;
				}
			} );
			// object.scale(0.1, 0.1, 0.1);
			spaceship.add(object);
			object.name = "ship";
			object.scale.set(0.04, 0.04, 0.04);
			object.position.set(0,0, -200);
			spaceship = object;
			self.spaceShip = spaceship;
			camera.add(self.spaceShip);
			self.loaded = true;
			
		});
	this.hitbox = new THREE.Box3();
	this.update = function() {
		   if(!spaceship) return
		   this.hitbox.setFromObject(spaceship);
		}
	this.getShip = function(){
		return spaceship;
	}
	return this;
}	
   		
//asteroids function
var Asteroid = function() {
  var loader = new THREE.OBJLoader( manager );	
  var mesh = new THREE.Object3D(), self = this
  this.loaded = false

  // Speed of motion and rotation
  mesh.velocity = Math.random() * 2 + 2
  mesh.vRotation = new THREE.Vector3(Math.random(), Math.random(), Math.random())
  this.hitbox = new THREE.Box3();

  loader.load('decimated_2.obj', function(obj) {
    obj.traverse(function(child) {
      if(child instanceof THREE.Mesh) {
        child.material = materialGreenApple;
      }
    })

    obj.scale.set(2,2,2)
    mesh.add(obj)
    mesh.position.set(-50 + Math.random() * 100,
    				  -50 + Math.random() * 100, 
    				  -1500 - Math.random() * 1500)
    self.loaded = true
  })

  this.update = function(z) {
    mesh.position.z += mesh.velocity
    mesh.rotation.x += mesh.vRotation.x * 0.02;
    mesh.rotation.y += mesh.vRotation.y * 0.02;
    mesh.rotation.z += mesh.vRotation.z * 0.02;

    if(mesh.children.length > 0) this.hitbox.setFromObject(mesh.children[0])


    if(mesh.position.z > z) {
      this.reset(z);	
      mesh.velocity = Math.random() * 2 + 2
      mesh.position.set(
        -50 + Math.random() * 150,
        -50 + Math.random() * 150, 
        z - 1500 - Math.random() * 1000
      )
    }
  }

    this.reset = function(z) {
	   mesh.velocity = Math.random() * 2 + 2
	   mesh.position.set(-50 + Math.random() * 100, -50 + Math.random() * 100, z - 1500 - Math.random() * 1500)
	}

  this.getMesh = function() {
    return mesh
  }

  return this
}	

// var Shot = function(initialPos) {
// 	var box = new THREE.Object3D(), self = this
// 	var shape = new THREE.SphereGeometry(3, 15, 15);
// 	var material = new THREE.MeshBasicMaterial({color: 0xFFFFFF});
// 	this.mesh = new THREE.Mesh(shape, material); 
// 	this.mesh.position.copy(initialPos);



// 	this.getMesh = function() {
// 	   return this.mesh
// 	}
// 	this.hitbox = new THREE.Box3();
// 	this.update = function(z) {
// 	   this.mesh.position.z -= 15;
// 	   this.hitbox.setFromObject(this.mesh);
// 	   if(Math.abs(this.mesh.position.z - z) > 1000) {
// 	     return false
// 	     delete this.mesh
// 	   }
// 	   return true
// 	}
// 	return this

// }	

for(var i=0; i<NUMOFASTEROIDS; i++){
	asteroids.push(new Asteroid());
	scene.add(asteroids[i].getMesh());
}					

	// checkGamePad = function(){
	//   if(!!navigator.getGamepads){
	//     var gamepad = navigator.getGamepads();
	//     console.log(gamepad[0].id);
	//   }
	// }

	// leftJoystick = function() {
	//   var gamepad = navigator.getGamepads();
	//   if(gamepad[0].axes[0] < 0.25 && gamepad[0].axes[0] > -0.25 ){ //stick in middle
	//   	rotationX = 0;
	//  	new TWEEN.Tween(ship.rotation).to({z: 0}, 150).start().onComplete(function() {
	// 															  console.log('done!')
	// 															}); 
	//   }else if (gamepad[0].axes[0] < -0.25){ //stick to left
	//     rotationX = -1.5;
	//  	new TWEEN.Tween(ship.rotation).to({z: 0.2}, 150).start();
	//   }else if(gamepad[0].axes[0] > 0.25){ // stick to right
	//     rotationX = 1.5;
	//  	new TWEEN.Tween(ship.rotation).to({z: -0.2}, 150).start();
	//   }
	  // } else if(gamepad[0].axes[1] > 0.25){
	  //   rotationY = 1.5;
	 	// new TWEEN.Tween(ship.rotation).to({x: 0.3}, 150).start();
	  // }else if (gamepad[0].axes[1] < -0.25){
	  //   rotationY = -1.5;
	 	// new TWEEN.Tween(ship.rotation).to({x: -0.3}, 150).start();
	  // }
	// }

	// rightJoystick = function(){
	//   var gamepad = navigator.getGamepads();
	//   if(gamepad[0].axes[2] > 0.25){
	//     ball.rotation.y += 0.01;
	//   }else if(gamepad[0].axes[2] < -0.25){
	//     ball.rotation.y -= 0.01;
	//   }else if(gamepad[0].axes[3] > 0.25){
	//     ball.rotation.x += 0.01;
	//   }else if(gamepad[0].axes[3] < -0.25){
	//     ball.rotation.x -= 0.01;
	//   }
	// }

	var animate = function(){
	  requestAnimationFrame(animate);
	  renderer.render(scene, camera);
	  // leftJoystick();
	  // rightJoystick();
	  ship1.update();
	  if(spaceship !== undefined){	
	  	if(controller_state.moveX !== undefined){
	  		spaceship.position.x += controller_state.moveX;
	  		if(spaceship.rotation.z == 0.04999999999999999 || spaceship.rotation.z == -0.04999999999999999){
	  			spaceship.rotation.z = 0;
	  		}else if(controller_state.moveX == -1.5 && spaceship.rotation.z <= 0.3){
	  			spaceship.rotation.z += 0.05;
	  		} else if(controller_state.moveX == 0 && spaceship.rotation.z > 0){
	  			spaceship.rotation.z -= 0.05;
	  		} else if(controller_state.moveX == 1.5 && spaceship.rotation.z >= -0.3){
	  			spaceship.rotation.z -= 0.05;
	  		} else if(controller_state.moveX == 0 && spaceship.rotation.z < 0){
	  			spaceship.rotation.z += 0.05;
	  		}
	  		// console.log(spaceship.rotation.z);
	  	}
	  	if(controller_state.moveY !== undefined){
	  		spaceship.position.y += controller_state.moveY;
	  		if(spaceship.rotation.x == 0.04999999999999999 || spaceship.rotation.x == -0.04999999999999999){
	  			spaceship.rotation.x = 0;
	  		}else if(controller_state.moveY == 1.5 && spaceship.rotation.x <= 0.3){
	  			spaceship.rotation.x += 0.05;
	  		}else if(controller_state.moveY == 0 && spaceship.rotation.x > 0){
	  			spaceship.rotation.x -= 0.05;
	  		}else if(controller_state.moveY == -1.5 && spaceship.rotation.x >= -0.3){
	  			spaceship.rotation.x -= 0.05;
	  		}else if(controller_state.moveY == 0 && spaceship.rotation.x < 0){
	  			spaceship.rotation.x += 0.05;
	  		}
	  		
	  	}
	  		
	  	camera.position.z -= 5;
	  }

	  for(var i=0; i<2; i++){
	  	if(tunnels[i].position.z > camera.position.z + 2500 ){
	  		tunnels[i].position.z = tunnels[i].position.z -4000;
	  	}
	  }

	  //check for collision between sticks and ship
	  for(var i=0;i<NUMOFASTEROIDS;i++){
	    asteroids[i].update(camera.position.z);
	  if(ship1.hitbox.isIntersectionBox(asteroids[i].hitbox)) {
	     asteroids[i].reset(camera.position.z)
	   }
	  } 

	  // check if shots are still alive
	  for(var i=0; i<shots.length; i++) {
		   if(!shots[i].update(camera.position.z)) {
		     scene.remove(shots[i].getMesh())
		     shots.splice(i, 1)
		   }
		}

		//check for collision between shots and asteroids
	  for(var j=0; j<shots.length; j++) {
	     if(asteroids[i].hitbox.isIntersectionBox(shots[j].hitbox)) {
	       asteroids[i].reset(camera.position.z)
	       scene.remove(shots[j].getMesh());
	       shots.splice(j, 1)
	       // break
	     }
	   }
	   TWEEN.update();	
	}
	controller_state = {};


	// checkGamePad();
		var ship1 = new spaceShip();
		animate();

		$('#backarrow').on('click', function(){
			new TWEEN.Tween(spaceship.rotation).to({z: 0.3}, 150).start();
			console.log('tween');
		})
		

		// Tell the server that the client is connecting as a game
		io.emit('game_connect');
		// When the server has registered this client as a game
		// Create a QR code which will be a url with this game id as a parameter
		io.on('game_connected', game_connected);
		// When a controller has connected/disconnected to this game
		io.on('controller_connected', function(connected){
			if(connected){
				// Hide the QR code
				QR_code_element.style.display = "none";
			}else{
				// Show the QR code
				QR_code_element.style.display = "block";
				controller_state = {};
			}
		})
		// When the server sends a changed controller state update it in the game
		io.on('controller_state_change', function(state){
			controller_state = state;
		});
	},
	// Controller set up
	controller = function(game_id){
		// Tell the server this client is connecting as a controller
		// sending the id of the game to connect to
		io.emit('controller_connect', game_id);
		// Server will send back a connected boolean
		io.on('controller_connected', function(connected){
			if(connected){
				// Successful connection
				// alert("Connected!");
				var controller_state = {
					accelerate: false,
					steer: 0
				},
				emit_updates = function(){
					io.emit('controller_state_change', controller_state);
				}
				backarrowstart = function(e){
					e.preventDefault();
					controller_state.moveX = -1.5;
					emit_updates();
				},
				backarrowend = function(e){
					e.preventDefault();
					controller_state.moveX = 0;
					emit_updates();
				},
				arrowstart = function(e){
					e.preventDefault();
					controller_state.moveX = 1.5;
					emit_updates();
				},
				arrowend = function(e){
					e.preventDefault();
					controller_state.moveX = 0;
					emit_updates();
				},
				toparrowstart = function(e){
					e.preventDefault();
					controller_state.moveY = -1.5;
					emit_updates();
				},
				toparrowend = function(e){
					e.preventDefault();
					controller_state.moveY = 0;
					emit_updates();
				},
				bottomarrowstart = function(e){
					e.preventDefault();
					controller_state.moveY = 1.5;
					emit_updates();
				},
				bottomarrowend = function(e){
					e.preventDefault();
					controller_state.moveY = 0;
					emit_updates();
				},
				touchstart = function(e){
					e.preventDefault();
					controller_state.moveX = -1.5;
					emit_updates();
				},
				touchend = function(e){
					e.preventDefault();
					controller_state.moveX = -0;
					emit_updates();
				},
				devicemotion = function(e){
					controller_state.steer = e.acceleration.x * 100;
					emit_updates();
				}
				document.getElementById('backarrow').addEventListener('touchstart', backarrowstart, false);
				document.getElementById('backarrow').addEventListener('touchend', backarrowend, false);

				document.getElementById('arrow').addEventListener('touchstart',arrowstart, false);
				document.getElementById('arrow').addEventListener('touchend', arrowend, false);

				document.getElementById('bottomarrow').addEventListener('touchstart',toparrowstart, false);
				document.getElementById('bottomarrow').addEventListener('touchend', toparrowend, false);

				document.getElementById('toparrow').addEventListener('touchstart',bottomarrowstart, false);
				document.getElementById('toparrow').addEventListener('touchend', bottomarrowend, false);
				// document.body.addEventListener('touchstart', touchstart, false); // iOS & Android
				document.body.addEventListener('MSPointerDown', touchstart, false); // Windows Phone
				document.body.addEventListener('touchend', touchend, false); // iOS & Android
				document.body.addEventListener('MSPointerUp', touchend, false); // Windows Phone
				window.addEventListener('devicemotion', devicemotion, false);
				
			}else{
				// Failed connection
				// alert("Not connected!");
			}
			
		});
	}
	// If the url has an id in it
	if(current_url.indexOf('?id=') > 0){
		$('.buttons').show();
		// Set up the controller using the game id in the url
		controller(current_url.split('?id=')[1])
	}else{
		$('.buttons').hide();
		// Set up the game using ip
		game(ip);
	}


	function handleKeyDown(event){
	 if(event.keyCode == 83){ //s
	 	
	 }else if(event.keyCode == 37){ //left arrow
	 	rotationX = -2.5;
	    new TWEEN.Tween(spaceship.rotation).to({z: 0.3}, 150).start();
	 }else if(event.keyCode == 39){ //right arrow
	 	rotationX = 2.5;
	 	new TWEEN.Tween(spaceship.rotation).to({z: -0.3}, 150).start();
	 }else if(event.keyCode == 38){ //up arrow
	 	rotationY = 2.5;
	 	new TWEEN.Tween(spaceship.rotation).to({x: 0.35}, 150).start();
	 }else if(event.keyCode == 40){ //down arrow
	 	rotationY = -2.5;
	 	new TWEEN.Tween(spaceship.rotation).to({x: -0.35}, 150).start();
	 }
	}
	function handleKeyUp(event){
	 if(event.keyCode == 83){ //s
	 }else if(event.keyCode == 37){ //left arrow
	 	rotationX = 0;
	 	new TWEEN.Tween(spaceship.rotation).to({z: 0}, 150).start();
	 }else if(event.keyCode == 39){ //right arrow
	 	rotationX = 0;
	 	new TWEEN.Tween(spaceship.rotation).to({z: 0}, 150).start();
	 }else if(event.keyCode == 38){ //up arrow
	 	rotationY = 0;
	 	new TWEEN.Tween(spaceship.rotation).to({x: 0}, 150).start();
	 }else if(event.keyCode == 40){ //down arrow
	 	rotationY = 0;
	 	new TWEEN.Tween(spaceship.rotation).to({x: 0}, 150).start();
	 }
	}

});
</script>
</html>
